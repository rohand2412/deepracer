import numpy as np

class PARAMS:
    prev_progress = None
    prev_steps = None
    waypoints = np.array([
        [-6.98943482e+00,  9.43785328e-01],
        [-7.04721071e+00,  6.63214022e-01],
        [-7.08960062e+00,  3.76978830e-01],
        [-7.11723677e+00,  8.68253908e-02],
        [-7.13047669e+00, -2.05478778e-01],
        [-7.12947581e+00, -4.98169272e-01],
        [-7.11444703e+00, -7.89602360e-01],
        [-7.08563836e+00, -1.07838034e+00],
        [-7.04256079e+00, -1.36312221e+00],
        [-6.98470047e+00, -1.64249929e+00],
        [-6.91125642e+00, -1.91512885e+00],
        [-6.81955943e+00, -2.17862187e+00],
        [-6.70729146e+00, -2.43038273e+00],
        [-6.57011387e+00, -2.66593762e+00],
        [-6.40408396e+00, -2.87947205e+00],
        [-6.20702770e+00, -3.06328863e+00],
        [-5.98822091e+00, -3.22038206e+00],
        [-5.75315865e+00, -3.35269316e+00],
        [-5.50583550e+00, -3.46198401e+00],
        [-5.24921143e+00, -3.54978552e+00],
        [-4.98558917e+00, -3.61761148e+00],
        [-4.71677137e+00, -3.66701564e+00],
        [-4.44382575e+00, -3.69769135e+00],
        [-4.16717141e+00, -3.69862415e+00],
        [-3.88992492e+00, -3.67461438e+00],
        [-3.61351187e+00, -3.63050899e+00],
        [-3.33852629e+00, -3.57015447e+00],
        [-3.06516964e+00, -3.49654677e+00],
        [-2.79344690e+00, -3.41207160e+00],
        [-2.52321559e+00, -3.31891256e+00],
        [-2.25433465e+00, -3.21859329e+00],
        [-1.98663005e+00, -3.11246123e+00],
        [-1.71990501e+00, -3.00173899e+00],
        [-1.45395029e+00, -2.88754613e+00],
        [-1.18853479e+00, -2.77098916e+00],
        [-9.23465903e-01, -2.65293906e+00],
        [-6.61409078e-01, -2.53552783e+00],
        [-4.00630179e-01, -2.41938827e+00],
        [-1.40637273e-01, -2.30428116e+00],
        [ 1.18825318e-01, -2.19009711e+00],
        [ 3.77897946e-01, -2.07679903e+00],
        [ 6.36666147e-01, -1.96436254e+00],
        [ 8.95172786e-01, -1.85278913e+00],
        [ 1.15344155e+00, -1.74207613e+00],
        [ 1.41147827e+00, -1.63224426e+00],
        [ 1.66927734e+00, -1.52333885e+00],
        [ 1.92681218e+00, -1.41548185e+00],
        [ 2.18405396e+00, -1.30880485e+00],
        [ 2.44096295e+00, -1.20348610e+00],
        [ 2.69748433e+00, -1.09977035e+00],
        [ 2.95356424e+00, -9.97902384e-01],
        [ 3.20907748e+00, -8.98431899e-01],
        [ 3.46388631e+00, -8.01965571e-01],
        [ 3.71781050e+00, -7.09286878e-01],
        [ 3.97061922e+00, -6.21426556e-01],
        [ 4.22220567e+00, -5.39660399e-01],
        [ 4.47362065e+00, -4.59151288e-01],
        [ 4.72493933e+00, -3.79462311e-01],
        [ 4.97943609e+00, -2.99249799e-01],
        [ 5.23275449e+00, -2.13031996e-01],
        [ 5.48258382e+00, -1.15073484e-01],
        [ 5.72503566e+00,  1.88155818e-04],
        [ 5.95458042e+00,  1.38156156e-01],
        [ 6.16275707e+00,  3.04514562e-01],
        [ 6.34721920e+00,  4.95185553e-01],
        [ 6.50875877e+00,  7.04673342e-01],
        [ 6.64744179e+00,  9.29361044e-01],
        [ 6.76338597e+00,  1.16617112e+00],
        [ 6.85614533e+00,  1.41262570e+00],
        [ 6.92533368e+00,  1.66630930e+00],
        [ 6.97045095e+00,  1.92479650e+00],
        [ 6.99049873e+00,  2.18554602e+00],
        [ 6.98409715e+00,  2.44572904e+00],
        [ 6.94926108e+00,  2.70204656e+00],
        [ 6.88168820e+00,  2.94976261e+00],
        [ 6.77629324e+00,  3.18179231e+00],
        [ 6.62811052e+00,  3.38800141e+00],
        [ 6.43251458e+00,  3.55259063e+00],
        [ 6.20656735e+00,  3.68032759e+00],
        [ 5.95874179e+00,  3.77436407e+00],
        [ 5.69556395e+00,  3.83882883e+00],
        [ 5.42154936e+00,  3.87681929e+00],
        [ 5.14036269e+00,  3.89138612e+00],
        [ 4.85496485e+00,  3.88532955e+00],
        [ 4.56771851e+00,  3.86105880e+00],
        [ 4.28047468e+00,  3.82060233e+00],
        [ 3.99463208e+00,  3.76570540e+00],
        [ 3.71118553e+00,  3.69791515e+00],
        [ 3.43082884e+00,  3.61845004e+00],
        [ 3.15404598e+00,  3.52823833e+00],
        [ 2.88110301e+00,  3.42817774e+00],
        [ 2.61212864e+00,  3.31906008e+00],
        [ 2.34721717e+00,  3.20146874e+00],
        [ 2.08658630e+00,  3.07558152e+00],
        [ 1.83075701e+00,  2.94097349e+00],
        [ 1.58063162e+00,  2.79662476e+00],
        [ 1.33754855e+00,  2.64095108e+00],
        [ 1.10352912e+00,  2.47157064e+00],
        [ 8.75873661e-01,  2.29296260e+00],
        [ 6.53097815e-01,  2.10740620e+00],
        [ 4.34113085e-01,  1.91650803e+00],
        [ 2.18013974e-01,  1.72157201e+00],
        [ 3.94947787e-03,  1.52380201e+00],
        [-2.08939212e-01,  1.32439904e+00],
        [-4.22136389e-01,  1.12382967e+00],
        [-6.36527331e-01,  9.25161201e-01],
        [-8.53326346e-01,  7.30422259e-01],
        [-1.07381032e+00,  5.41992463e-01],
        [-1.29915168e+00,  3.62571800e-01],
        [-1.53032968e+00,  1.95383800e-01],
        [-1.76799780e+00,  4.45095308e-02],
        [-2.01210657e+00, -8.49833354e-02],
        [-2.26140632e+00, -1.86956710e-01],
        [-2.51291149e+00, -2.54243467e-01],
        [-2.76142789e+00, -2.79186030e-01],
        [-2.99897737e+00, -2.54127601e-01],
        [-3.21406124e+00, -1.73619959e-01],
        [-3.38791459e+00, -3.37080397e-02],
        [-3.52281098e+00,  1.43721416e-01],
        [-3.62196276e+00,  3.47938445e-01],
        [-3.68670183e+00,  5.72907162e-01],
        [-3.71768289e+00,  8.14007850e-01],
        [-3.71649250e+00,  1.06671323e+00],
        [-3.68477675e+00,  1.32657964e+00],
        [-3.62561251e+00,  1.58537128e+00],
        [-3.59239701e+00,  1.83795788e+00],
        [-3.59289662e+00,  2.08155515e+00],
        [-3.63358960e+00,  2.31174398e+00],
        [-3.72184835e+00,  2.52180613e+00],
        [-3.86871875e+00,  2.69826947e+00],
        [-4.06237585e+00,  2.83728515e+00],
        [-4.29148033e+00,  2.93630012e+00],
        [-4.54455928e+00,  2.99321466e+00],
        [-4.80974327e+00,  3.00800535e+00],
        [-5.07677188e+00,  2.98288838e+00],
        [-5.33827098e+00,  2.92208645e+00],
        [-5.58979155e+00,  2.83029110e+00],
        [-5.82807299e+00,  2.71025071e+00],
        [-6.05059102e+00,  2.56430056e+00],
        [-6.25422258e+00,  2.39317332e+00],
        [-6.43119574e+00,  2.19343448e+00],
        [-6.58349214e+00,  1.97181665e+00],
        [-6.71373373e+00,  1.73316222e+00],
        [-6.82389925e+00,  1.48073829e+00],
        [-6.91536813e+00,  1.21691806e+00]
    ])
    speeds = np.array([
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 0.94497889, 0.8454445 , 0.77209455,
        0.77209455, 0.77209455, 0.77209455, 0.77209455, 0.86023845,
        0.92801365, 0.99126946, 0.94472519, 0.94472519, 0.94472519,
        0.94472519, 0.94472519, 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 0.98348112, 0.84025128, 0.84025128, 0.84025128,
        0.84025128, 0.84025128, 0.85536005, 0.91188163, 0.94551739,
        0.97423801, 0.95118535, 0.9084982 , 0.83089469, 0.74965715,
        0.67448885, 0.60129364, 0.60129364, 0.60129364, 0.60129364,
        0.60129364, 0.6998964 , 0.77926431, 0.87712535, 0.96909953,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 0.98187044, 0.85664748, 0.74549643, 0.64738576,
        0.5709984 , 0.5       , 0.5       , 0.5       , 0.5       ,
        0.5       , 0.56837203, 0.63216347, 0.68701248, 0.74193136,
        0.81094405, 0.69674091, 0.60387333, 0.52161495, 0.52161495,
        0.52161495, 0.52161495, 0.52161495, 0.56954352, 0.63247147,
        0.69241352, 0.74686734, 0.79227006, 0.83693885, 0.79859441,
        0.79859441, 0.79859441, 0.79859441, 0.79859441, 0.87510029,
        0.96271511, 1.        , 1.        , 1.        , 1.        
    ])
    steering_angles = np.array([
        2.76465525,   2.32309052,   1.99509884,   1.79324417,
        1.7068229 ,   1.66652411,   1.66728047,   1.91049985,
        2.19588955,   2.58513707,   3.47168139,   4.25875355,
        5.43246331,   6.46574256,   7.29556864,   6.30529522,
        5.60087345,   4.98901802,   4.46647434,   3.97647784,
        3.49288061,   3.45869866,   5.43495842,   4.52761585,
        3.50195983,   2.55287093,   1.70795494,   0.95723214,
        0.2052108 ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   1.79524336,
        3.56549702,   5.06198981,   6.52262683,   6.35794144,
        5.76395584,   5.42716972,   5.14944867,   5.04225631,
        4.97000238,   4.96540136,   5.10544833,   5.37164495,
        5.79852386,   6.62584615,   7.56034586,   8.48079359,
        9.41730395,   8.16429672,   7.21200649,   6.125061  ,
        5.19847253,   4.30637474,   3.50168617,   2.82422773,
        2.2745024 ,   1.82200011,   1.43204567,   1.13273018,
        0.91236612,   0.68748887,   0.47972353,   0.32896467,
        0.31761978,   0.52940723,   0.95586963,   1.55999981,
        2.37177996,   0.92558111,   0.02825319,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,  -0.56393656,
        -1.59563045,  -2.70085052,  -3.86291469,  -5.07716317,
        -6.34402275,  -7.60997924,  -8.82371356,  -9.81274866,
        -10.74582577,  -9.84716835,  -9.01844273,  -8.32415166,
        -7.6526372 ,  -6.84904925,  -6.09387299,  -5.41270184,
        5.03761158,   6.83550822,   8.20332297,   9.38379397,
        10.46174415,   9.83181336,   9.01448885,   8.25697571,
        7.59360746,   7.06175072,   6.55906132,   6.08693655,
        5.91575662,   5.8142942 ,   6.00209497,   6.98931022,
        6.14651004,   5.25978575,   4.50322029,   3.88150873,
        3.29014896
    ])

def reward_function(params):
    if PARAMS.prev_steps is None or params['steps'] < PARAMS.prev_steps:
        PARAMS.prev_progress = params['progress']

    distances_to_waypoints = np.hypot(PARAMS.waypoints[:, 0] - params['x'], PARAMS.waypoints[:, 1] - params['y'])
    closest_waypoint = np.argmin(distances_to_waypoints)
    normalized_distance_from_route = distances_to_waypoints[closest_waypoint] / (params['track_width'] * 0.5)

    reward = 25

    reward -= abs(params['steering_angle'] - PARAMS.steering_angles[closest_waypoint]) / 8
    reward -= abs(params['speed'] - PARAMS.speeds[closest_waypoint]) * 10
    reward -= normalized_distance_from_route * 5

    diff = params['progress'] - PARAMS.prev_progress
    reward *= diff

    # if params['progress'] == 100:
        # reward += ((25 - 0) / (740 - 820)) * (params['steps'] - 820)
        # reward += 20000 / params['steps']

    # diff = params['progress'] - PARAMS.prev_progress
    # speed_ratio = params['speed'] / PARAMS.speeds[closest_waypoint]
    # steering_diff = 5 - abs(params['steering_angle'] - PARAMS.steering_angles[closest_waypoint]) / 8
    # reward = max(0, diff * speed_ratio * steering_diff)

    # diff = params['progress'] - PARAMS.prev_progress
    # reward = diff ** 2

    if not params['all_wheels_on_track']:
        reward = 0.001

    PARAMS.prev_progress = params['progress']
    PARAMS.prev_steps = params['steps']
    return float(reward)
