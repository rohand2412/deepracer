import numpy as np

class PARAMS:
    prev_progress = None
    prev_steps = None
    waypoints = np.array([
        [ 6.09498991,  1.5758676 ],
        [ 5.81849615,  1.67454241],
        [ 5.53439885,  1.76494088],
        [ 5.24572697,  1.85031353],
        [ 4.9576148 ,  1.9403503 ],
        [ 4.67081015,  2.03392312],
        [ 4.38512431,  2.13040579],
        [ 4.1004054 ,  2.22936986],
        [ 3.81654221,  2.33051077],
        [ 3.5334495 ,  2.4335983 ],
        [ 3.25108328,  2.5385107 ],
        [ 2.96935891,  2.6450276 ],
        [ 2.68823415,  2.7530376 ],
        [ 2.4076953 ,  2.86250154],
        [ 2.12773613,  2.9733994 ],
        [ 1.84835706,  3.08572781],
        [ 1.56956489,  3.19949936],
        [ 1.29137127,  3.31473854],
        [ 1.01378957,  3.43147401],
        [ 0.73683099,  3.54972903],
        [ 0.46050118,  3.66951324],
        [ 0.18479861,  3.79081879],
        [-0.09028559,  3.91361998],
        [-0.3647674 ,  4.03787406],
        [-0.63866955,  4.16352219],
        [-0.91202136,  4.29048998],
        [-1.18485839,  4.41868843],
        [-1.45722136,  4.54801676],
        [-1.72915056,  4.6783755 ],
        [-2.00067293,  4.80969724],
        [-2.27180009,  4.94195065],
        [-2.5425269 ,  5.07514335],
        [-2.81282958,  5.20932546],
        [-3.08266705,  5.34458522],
        [-3.35200156,  5.48100031],
        [-3.62080641,  5.61862071],
        [-3.88895345,  5.75771999],
        [-4.15604141,  5.89394166],
        [-4.42304736,  6.01872062],
        [-4.68921175,  6.12351571],
        [-4.95328503,  6.20117842],
        [-5.21362107,  6.24562809],
        [-5.46824964,  6.25198567],
        [-5.71337887,  6.21017415],
        [-5.94245013,  6.10924076],
        [-6.15693047,  5.96671901],
        [-6.35741862,  5.79010798],
        [-6.54433907,  5.58457457],
        [-6.71866621,  5.35548141],
        [-6.87704231,  5.10533185],
        [-7.0136256 ,  4.84337874],
        [-7.12519283,  4.5756632 ],
        [-7.21101806,  4.30528273],
        [-7.27101015,  4.03431316],
        [-7.30514276,  3.76437264],
        [-7.31244357,  3.49696478],
        [-7.28903597,  3.23416296],
        [-7.22983093,  2.97903748],
        [-7.12705946,  2.73697777],
        [-6.98933846,  2.50863282],
        [-6.82330139,  2.29363686],
        [-6.63503669,  2.09064254],
        [-6.42874114,  1.8984475 ],
        [-6.20823501,  1.7155022 ],
        [-5.97727631,  1.53982448],
        [-5.73940179,  1.36921077],
        [-5.50685243,  1.20874498],
        [-5.29113282,  1.04066473],
        [-5.10582931,  0.85921648],
        [-4.96188446,  0.66057497],
        [-4.86944836,  0.44247676],
        [-4.84438425,  0.2033394 ],
        [-4.86625135, -0.04723787],
        [-4.92855185, -0.30578636],
        [-5.02428815, -0.56966771],
        [-5.14466755, -0.83684932],
        [-5.2795455 , -1.10576959],
        [-5.41756702, -1.37463316],
        [-5.54531153, -1.64276312],
        [-5.65416992, -1.90965244],
        [-5.73605093, -2.17414838],
        [-5.78452231, -2.43465372],
        [-5.79380413, -2.68898567],
        [-5.75747707, -2.93392919],
        [-5.66390539, -3.16288032],
        [-5.52697053, -3.37616872],
        [-5.35403454, -3.574102  ],
        [-5.1507004 , -3.75720959],
        [-4.92323716, -3.9271121 ],
        [-4.677321  , -4.0858525 ],
        [-4.41929878, -4.23655402],
        [-4.15527566, -4.38282561],
        [-3.89035392, -4.52827597],
        [-3.62541854, -4.67370439],
        [-3.3605026 , -4.81916833],
        [-3.09558952, -4.96463752],
        [-2.83075684, -5.11025171],
        [-2.56599199, -5.25545859],
        [-2.30105768, -5.39863435],
        [-2.03566815, -5.53774077],
        [-1.76957227, -5.67070545],
        [-1.50256338, -5.79538681],
        [-1.23447569, -5.90948755],
        [-0.96519064, -6.01046815],
        [-0.69466814, -6.09567161],
        [-0.42294939, -6.16203593],
        [-0.15017869, -6.20546372],
        [ 0.12327139, -6.21953469],
        [ 0.39632285, -6.19590335],
        [ 0.66812729, -6.14440917],
        [ 0.93836121, -6.07007126],
        [ 1.20686673, -5.97638379],
        [ 1.47357802, -5.86621341],
        [ 1.73858858, -5.74270862],
        [ 2.00206232, -5.60860915],
        [ 2.26420542, -5.46626841],
        [ 2.52517653, -5.31766038],
        [ 2.78421467, -5.16383495],
        [ 3.04016059, -5.00594128],
        [ 3.2928176 , -4.84460843],
        [ 3.54211627, -4.68011489],
        [ 3.78800876, -4.51262297],
        [ 4.03045914, -4.34224863],
        [ 4.26941134, -4.16906324],
        [ 4.50481101, -3.99312414],
        [ 4.73637532, -3.81431352],
        [ 4.96370977, -3.6324493 ],
        [ 5.18623514, -3.44724638],
        [ 5.40310385, -3.25828489],
        [ 5.61305367, -3.06496057],
        [ 5.81444519, -2.86657798],
        [ 6.00482105, -2.6622177 ],
        [ 6.18145803, -2.45124335],
        [ 6.34812614, -2.23596337],
        [ 6.50497978, -2.01674457],
        [ 6.65209212, -1.79388898],
        [ 6.78933858, -1.56761442],
        [ 6.91646531, -1.33809422],
        [ 7.03252433, -1.10530359],
        [ 7.13604315, -0.86913104],
        [ 7.22532138, -0.62949386],
        [ 7.2973423 , -0.38616648],
        [ 7.34859863, -0.13915989],
        [ 7.37413017,  0.11109349],
        [ 7.36535942,  0.3626624 ],
        [ 7.31304498,  0.60903093],
        [ 7.20775891,  0.83704329],
        [ 7.03922728,  1.02822679],
        [ 6.83731758,  1.19464284],
        [ 6.60890042,  1.3391942 ],
        [ 6.35995879,  1.46528981]
    ])
    speeds = np.array([
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 0.98762044,
        0.84499946, 0.7465053 , 0.63420939, 0.56078384, 0.56078384,
        0.56078384, 0.56078384, 0.56078384, 0.67728516, 0.77380078,
        0.87322149, 1.        , 0.98516561, 0.96096198, 0.92084259,
        0.84155149, 0.76471391, 0.68456917, 0.68456917, 0.68456917,
        0.68456917, 0.68456917, 0.76204304, 0.85158796, 0.97027751,
        1.        , 1.        , 0.85435975, 0.68040936, 0.5748695 ,
        0.5       , 0.5       , 0.5       , 0.5       , 0.5       ,
        0.63094166, 0.73232205, 0.87081127, 1.        , 1.        ,
        0.84938069, 0.7384973 , 0.65070171, 0.5646372 , 0.5646372 ,
        0.5646372 , 0.5646372 , 0.5646372 , 0.6515261 , 0.73655836,
        0.83327899, 0.97072787, 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 0.89415477, 0.78473664, 0.78473664, 0.78473664,
        0.78473664, 0.78473664, 0.91905568, 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 1.        , 1.        , 1.        , 1.        ,
        1.        , 0.97035416, 0.87034896, 0.75546162, 0.66880332,
        0.59086047, 0.52052324, 0.52052324, 0.52052324, 0.52052324,
        0.52052324, 0.70936708, 0.81128465, 0.94421241, 1.        ,
        1.        
    ])
    steering_angles = np.array([
        2.03308508,   0.48776709,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.44887921,   2.70687309,   4.43949037,
        5.88211293,   7.02562669,   8.46477259,   9.46626229,
        7.89738353,   6.6968918 ,   5.57660829,   4.32587032,
        4.10423245,   3.92741021,   4.07812725,   4.25936874,
        4.46221765,   4.69016405,   5.08367688,   5.92012086,
        6.80534487,   7.80321827,   6.83741014,   5.80989977,
        4.60159768,   3.56720877,   2.47575954,   1.24202349,
        0.        ,   0.        ,  -2.59828296,  -5.77968198,
        -7.85692859,  -9.27147257, -10.31508193,  -8.50850076,
        -7.19989996,  -5.60230941,  -3.58644642,  -1.07788688,
        0.        ,   0.        ,   2.34835746,   4.3058139 ,
        5.83403199,   7.12373709,   8.24549692,   9.41287439,
        8.23460036,   7.14760393,   6.01191669,   4.59734244,
        3.14326678,   1.34172652,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.49566362,   1.33980757,   2.17871634,
        3.06654003,   4.09048012,   5.35644371,   6.56769193,
        5.10166413,   4.05742328,   3.16577825,   2.3396942 ,
        1.39075965,   0.50414385,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.        ,   0.        ,   0.        ,
        0.        ,   0.52001068,   1.39075804,   2.24536597,
        1.07009164,   1.06077384,   1.08139258,   1.17306537,
        1.31198228,   1.69523508,   2.23994895,   2.82489191,
        3.71768293,   4.60087328,   5.60724761,   6.91678603,
        8.00770814,   9.05168026,  10.02751778,   7.48680469,
        6.26012564,   4.85205666,   3.53995686
    ])

def reward_function(params):
    if PARAMS.prev_steps is None or params['steps'] < PARAMS.prev_steps:
        PARAMS.prev_progress = params['progress']

    distances_to_waypoints = np.hypot(PARAMS.waypoints[:, 0] - params['x'], PARAMS.waypoints[:, 1] - params['y'])
    closest_waypoint = np.argmin(distances_to_waypoints)
    normalized_distance_from_route = distances_to_waypoints[closest_waypoint] / (params['track_width'] * 0.5)

    reward = 25

    reward -= abs(params['steering_angle'] - PARAMS.steering_angles[closest_waypoint]) / 8
    reward -= abs(params['speed'] - PARAMS.speeds[closest_waypoint]) * 10
    reward -= normalized_distance_from_route * 5

    diff = params['progress'] - PARAMS.prev_progress
    reward *= diff

    if not params['all_wheels_on_track']:
        reward = 0.001

    PARAMS.prev_progress = params['progress']
    PARAMS.prev_steps = params['steps']
    return float(reward)

